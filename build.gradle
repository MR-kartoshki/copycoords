// Stonecutter + Fabric Loom Multi-Version Build Configuration

import java.util.Properties

plugins {
    id 'fabric-loom' version '1.15.0-alpha.6'
    id 'dev.kikugie.stonecutter'
    id 'maven-publish'
    id 'com.modrinth.minotaur' version '2.8.10' apply false
    id 'io.github.themrmilchmann.curseforge-publish' version '0.8.0' apply false
}

// Version mapping for Minecraft versions and their associated dependencies
ext.gameVersions = [
    '1.21.1': [
        fabric_api: '0.116.8+1.21.1',
        fabric_loader: '0.18.4',
        cloth_config: '15.0.140',
        modmenu: '11.0.3'
    ],
    '1.21.11': [
        fabric_api: '0.141.3+1.21.11',
        fabric_loader: '0.18.4',
        cloth_config: '11.0.99',
        modmenu: '17.0.0-beta.2'
    ]
]

// Default/active version for local development
String defaultVersion = '1.21.11'
def scExt = project.extensions.findByName('stonecutter')
def scVersion = scExt?.current?.version
String activeVersion = project.findProperty('MC_VERSION')
    ?: (scVersion ?: (ext.gameVersions.containsKey(project.name) ? project.name : defaultVersion))
println "Building for Minecraft version: ${activeVersion}"

// Meta properties
group = project.maven_group
version = project.mod_version

// Get the active version's dependency specs
def versionDeps = ext.gameVersions[activeVersion]
if (!versionDeps) {
    throw new GradleException("Unknown Minecraft version: ${activeVersion}. Supported versions: ${ext.gameVersions.keySet()}")
}

// Configure base name to include active version
base {
    archivesName = project.archives_base_name + "+${activeVersion}"
}

repositories {
    mavenCentral()
    maven {
        url = 'https://maven.fabricmc.net/'
    }
    maven {
        url = 'https://libraries.minecraft.net/'
    }
    maven {
        url = 'https://maven.shedaniel.me/'
    }
    maven {
        url = 'https://api.modrinth.com/maven'
    }
    maven {
        url = 'https://oss.sonatype.org/content/repositories/snapshots'
    }
    maven {
        url = 'https://maven.terraformersmc.com/releases/'
    }
}

dependencies {
    // Use the active version's Minecraft
    minecraft "com.mojang:minecraft:${activeVersion}"
    mappings loom.officialMojangMappings()

    // Load version-specific dependencies
    modImplementation "net.fabricmc:fabric-loader:${versionDeps.fabric_loader}"
    modImplementation "net.fabricmc.fabric-api:fabric-api:${versionDeps.fabric_api}"
    modImplementation "me.shedaniel.cloth:cloth-config-fabric:${versionDeps.cloth_config}"
    modApi "com.terraformersmc:modmenu:${versionDeps.modmenu}"
}

loom {
    runs {
        client {
            client()
            ideConfigGenerated = true
            source = sourceSets.main
        }
    }
}

tasks.withType(JavaCompile).configureEach {
    options.compilerArgs << "-Xlint:deprecation"
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
        }
    }
    repositories {
        mavenLocal()
    }
}

processResources {
    def versionValue = project.version
    def mcversionValue = activeVersion
    inputs.property "version", versionValue
    inputs.property "mcversion", mcversionValue
    filesMatching("fabric.mod.json") {
        expand "version": versionValue,
                "mcversion": mcversionValue
    }
}

// Task to build for all versions
task buildAllVersions {
    doLast {
        println "Building CopyCoords for all supported Minecraft versions..."
        ext.gameVersions.keySet().each { version ->
            println "Building for ${version}..."
            exec {
                commandLine "./gradlew.bat", "build", "-PMC_VERSION=${version}"
            }
        }
        println "All versions built successfully!"
    }
}

// Task to test all versions
task testAllVersions {
    doLast {
        println "Testing CopyCoords for all supported Minecraft versions..."
        ext.gameVersions.keySet().each { version ->
            println "Testing for ${version}..."
            exec {
                commandLine "./gradlew.bat", "test", "-PMC_VERSION=${version}"
            }
        }
        println "All versions tested successfully!"
    }
}

// Default build behavior
build.dependsOn remapJar
