name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      skip_modrinth:
        description: 'Skip Modrinth upload'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deps.json schema
        if: hashFiles('deps.json') != ''
        shell: bash
        run: bash .github/scripts/validate-deps.sh

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build all versions
        run: ./gradlew buildAllVersions --no-daemon

      - name: Extract current changelog
        run: ./gradlew writeCurrentChangelog --no-daemon

      - name: Publish to Modrinth
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.skip_modrinth != 'true')
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          PROJECT_ID="GzPkXb2a"
          MOD_VERSION="$(grep '^mod_version=' gradle.properties | cut -d= -f2-)"
          CHANGELOG="$(cat build/current-changelog.md)"

          if [[ -z "${MODRINTH_TOKEN:-}" ]]; then
            echo "::error::MODRINTH_TOKEN is not set"
            exit 1
          fi

          # Read optional dependency config from repo root (deps.json)
          # Expected format:
          # [
          #   {"project_id":"P7dR8mSH","dependency_type":"required"},
          #   {"project_id":"AANobbMI","dependency_type":"optional"}
          # ]
          DEPS_JSON='[]'
          if [[ -f deps.json ]]; then
            bash .github/scripts/validate-deps.sh deps.json
            DEPS_JSON="$(jq -c '.' deps.json)"
          else
            echo "::warning::deps.json not found in repo root; uploading with empty dependencies array."
          fi

          shopt -s nullglob
          JARS=(versions/*/build/libs/*.jar)
          if [[ ${#JARS[@]} -eq 0 ]]; then
            echo "No JAR files found under versions/*/build/libs"
            exit 1
          fi

          for JAR in "${JARS[@]}"; do
            # Skip non-primary artifacts
            if [[ "$JAR" == *-sources.jar || "$JAR" == *-javadoc.jar || "$JAR" == *-dev.jar ]]; then
              continue
            fi

            MC_VERSION="$(echo "$JAR" | sed -E 's#^versions/([^/]+)/.*#\1#')"
            VERSION_NUMBER="${MOD_VERSION}+${MC_VERSION}"
            VERSION_NAME="CopyCoords ${MOD_VERSION} for MC ${MC_VERSION}"

            # Keep existing payload fields and inject validated dependencies.
            PAYLOAD="$(jq -cn \
              --arg project_id "$PROJECT_ID" \
              --arg name "$VERSION_NAME" \
              --arg version_number "$VERSION_NUMBER" \
              --arg changelog "$CHANGELOG" \
              --arg mc "$MC_VERSION" \
              --argjson deps "$DEPS_JSON" \
              '{
                project_id: $project_id,
                name: $name,
                version_number: $version_number,
                changelog: $changelog,
                game_versions: [$mc],
                loaders: ["fabric"],
                featured: false,
                version_type: "release",
                dependencies: $deps
              }')"

            CHECK_STATUS="$(curl -sS -o /tmp/modrinth-check.json -w "%{http_code}" \
              -H "Authorization: ${MODRINTH_TOKEN}" \
              "https://api.modrinth.com/v2/project/${PROJECT_ID}/version/${VERSION_NUMBER}")"
            if [[ "$CHECK_STATUS" == "200" ]]; then
              echo "Version ${VERSION_NUMBER} already exists on Modrinth; skipping upload for ${JAR}."
              continue
            elif [[ "$CHECK_STATUS" != "404" ]]; then
              echo "::warning::Unexpected response while checking existing version (${CHECK_STATUS})."
              cat /tmp/modrinth-check.json || true
            fi

            echo "Uploading ${JAR} for MC ${MC_VERSION} as ${VERSION_NUMBER}"
            UPLOAD_STATUS="$(curl -sS -o /tmp/modrinth-upload.json -w "%{http_code}" -X POST "https://api.modrinth.com/v2/version" \
              -H "Authorization: ${MODRINTH_TOKEN}" \
              -F "data=${PAYLOAD};type=application/json" \
              -F "file=@${JAR}")"
            if [[ "$UPLOAD_STATUS" != "200" && "$UPLOAD_STATUS" != "201" ]]; then
              echo "::error::Modrinth upload failed with HTTP ${UPLOAD_STATUS} for ${JAR}."
              cat /tmp/modrinth-upload.json || true
              exit 1
            fi
          done

      - name: GitHub Release (attach jar)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          body_path: build/current-changelog.md
          files: |
            versions/*/build/libs/*.jar
